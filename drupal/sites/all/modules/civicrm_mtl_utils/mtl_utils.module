<?php// $Id: MtlUtils.module,v 1.263.2.4 2010/11/02 10:16:54 goba Exp $define( 'CIVICRM_MTL_UTILS_NEW_MEMBER_ACTIVITY_ID', '46' );define( 'CIVICRM_MTL_UTILS_EC_APPROVAL_ACTIVITY_ID', '47' );define( 'CIVICRM_MTL_UTILS_SEND_WELCOME_PACK_ACTIVITY_ID', '48' );define( 'CIVICRM_MTL_UTILS_NEW_MEMBER_ACTIVITY_ID', '46' );define( 'CIVICRM_MTL_UTILS_AWAITING_PAYMENT_ACTIVITY_ID', '50' );define( 'CIVICRM_MTL_UTILS_MEMBERSHIP_RENEWAL_ACTIVITY_ID', '54' );define( 'CIVICRM_MTL_UTILS_FULL_VOTING_MEMBERSHIP_PROFILE_ID' ,   '16' );define( 'CIVICRM_MTL_UTILS_ASSOCIATE_MEMBERSHIP_PROFILE_ID' ,   '14' );define( 'CIVICRM_MTL_UTILS_SPECIAL_FREEPHONE_TARIFF_PROFILE_ID' ,   '17' );define( 'CIVICRM_MTL_UTILS_MEMBERSHIP_APPROVAL_GROUP_ID' ,   '38' );function mtl_utils_civicrm_contactListQuery( &$query, $name, $context, $id ) {    if ($context == 'navigation') {        $query = "SELECT cc.id as id, CONCAT_WS( ' :: ', sort_name, email, phone, street_address, city, ste.name, coy.name ) as data, sort_name                       FROM civicrm_contact cc LEFT JOIN civicrm_email eml ON ( cc.id = eml.contact_id AND eml.is_primary = 1 )                       LEFT JOIN civicrm_phone phe ON ( cc.id = phe.contact_id AND phe.is_primary = 1 )                       LEFT JOIN civicrm_address sts ON ( cc.id = sts.contact_id AND sts.is_primary = 1)                       LEFT JOIN civicrm_state_province ste ON ( sts.state_province_id = ste.id )                       LEFT JOIN civicrm_country coy ON ( sts.country_id = coy.id )                      WHERE sort_name LIKE '%$name%' OR external_identifier = '$name'                      LIMIT 0,10";     }    if ($context == 'customfield' && $id == 96) {        $query = "SELECT cc.id as id, display_name as data                       FROM civicrm_contact cc                        WHERE contact_sub_type = 'Region'                      LIMIT 0,13";    }    }function mtl_utils_civicrm_tokens( &$tokens ) {    $tokens['contact'] = array( 'member_rep_name', 'member_rep_jobtitle' , 'chief_executive_name', 'chief_executive_jobtitle' );}function mtl_utils_civicrm_tokenValues( &$values, &$contactIDs ) {    //print_r ($values);exit;        if ( is_array( $contactIDs ) ) {        $contactIDString = implode( ',', array_values( $contactIDs ) );        $single = false;    } else {        $contactIDString = "( $contactIDs )";        $single = true;    }    if ( is_array( $contactIDs ) ) {            while(list($key,$val) = each($contactIDs)) {                         $contactIDString = $val;                        require_once "api/v2/Relationship.php";            $params = array(                        'contact_id'         => $contactIDString                        );                              //echo '<pre>';print_r($params);echo '</pre>';                              $result =  civicrm_contact_relationship_get ($params );            //echo '<pre>';print_r($result);echo '</pre>';exit;                        if($result['is_error'] == 0 ) {                            $temp_array = $result['result'];                                while( list( $k, $v ) = each($temp_array) ) {                        if( $v['civicrm_relationship_type_id'] == 10 AND $v['relation'] == 'Member Rep') {                            $member_rep_id = $v['cid'];                        }                        if( $v['civicrm_relationship_type_id'] == 11 AND $v['relation'] == 'Chief Executive is' ) {                            $chief_exe_id = $v['cid'];                        }                    }                                require_once "api/v2/Contact.php";                $params    = array(                       'contact_id' => $member_rep_id,                       'return.sort_name' => 1,                       'return.display_name' => 1,                       'return.job_title' => 1                       );                $retrieved = &civicrm_contact_get( $params );                                //print_r ($retrieved);                                if ( ! array_key_exists( $contactIDString, $values ) ) {                     $values[$contactIDString] = array( );                }                                $value =& $values[$contactIDString];                                $value['member_rep_name'] = $retrieved[$member_rep_id]['display_name'];                if( empty($retrieved[$member_rep_id]['display_name']) ) {                     $value['member_rep_name'] = $retrieved[$member_rep_id]['sort_name'];                    }                $value['member_rep_jobtitle'] = $retrieved[$member_rep_id]['job_title'];                                $params    = array(                       'contact_id' => $chief_exe_id,                       'return.sort_name' => 1,                       'return.display_name' => 1,                       'return.job_title' => 1                       );                $retrieved = &civicrm_contact_get( $params );                                //print_r ($retrieved);                                if ( ! array_key_exists( $contactIDString, $values ) ) {                     $values[$contactIDString] = array( );                }                                $value =& $values[$contactIDString];                                $value['chief_executive_name'] = $retrieved[$chief_exe_id]['display_name'];                if( empty($retrieved[$chief_exe_id]['display_name']) ) {                     $value['chief_executive_name'] = $retrieved[$chief_exe_id]['sort_name'];                    }                $value['chief_executive_jobtitle'] = $retrieved[$chief_exe_id]['job_title'];                                            }            }    }    //print_r ($value);exit;}function mtl_utils_civicrm_postProcess( $formName, &$form ){        global $user;    $contact_id = CRM_Core_BAO_UFMatch::getContactId( $user->uid );        require_once 'CRM/Core/Session.php';    $session = CRM_Core_Session::singleton( );            if ($formName == 'CRM_Contribute_Form_Contribution_Main' && $form->getVar( '_id' ) == 1) {                if (!empty($form->_submitValues['org_id'])) {            $session->set( 'org_id' , $form->_submitValues['org_id']);            }        if (!empty($form->_submitValues['membership_renewal'])) {            $session->set( 'membership_renewal' , $form->_submitValues['membership_renewal']);            }    }        if ( ! is_a($form, 'CRM_Contribute_Form_Contribution_Confirm') ) {        return;    }        if ($formName == 'CRM_Contribute_Form_Contribution_Confirm' && $form->getVar( '_id' ) == 5) {        if (!empty($form->_params['email-5'])) {            $session->set( 'registration_email' , $form->_params['email-5']);            }    }          civicrm_initialize( true );    require_once 'CRM/Core/Config.php';    $config =& CRM_Core_Config::singleton( );       require_once "api/v2/Contact.php";    require_once "api/v2/Relationship.php";    require_once "api/v2/GroupContact.php";    //print_r ($form);echo "<hr />";exit;        // if selected "on behalf of organization" then get that org ID    if ($form->_params['is_for_organization'] == 1) {         //get the Organization id that was submitted with this form - have to do it in a roundabout way        // get contacts related to contact submitting form (assumes the contact id is always set)        $relationParams = array( 'contact_id' => $form->_values['related_contact'] );                // If $form->_values['related_contact'] is empty, get the logged in users contact id        if (empty($form->_values['related_contact'])) {            $contact_id = CRM_Core_BAO_UFMatch::getContactId( $user->uid );            $relationParams = array( 'contact_id' => $contact_id );        }           $relatedContacts = & civicrm_relationship_get( $relationParams );        if ( civicrm_error ( $relatedContacts )) { return $relatedContacts['error_message']; }        //CRM_Core_Error::debug( $relatedContacts );        //use this email to ensure related org is the right one        $orgEmail = $form->_params['onbehalf_location']['email']['1']['email'];        // loop through multi-dimensional array and look for email that         // matches the org's email from the form        foreach ($relatedContacts['result'] as $related) {            foreach ($related as $relate) {               if ($relate == $orgEmail) { // it's probably the right org                   $relatedOrgID = $related['cid'];               }            }         }    } // endif "on behalf of org" is selected        //$org_id = $session->get( 'org_id');    //if (!empty($org_id)) $relatedOrgID = $org_id;          /* Create the approval required activity for new member requests */    //require_once 'CRM/Activity/DAO/Activity.php';    //$activity = new CRM_Activity_DAO_Activity( );    //$activity->source_contact_id  = $relatedOrgID;    //$activity->activity_type_id   = 46;    //$activity->activity_date_time = CRM_Utils_Date::getToday( null, 'YmdHis' );    //$activity->status_id          = 1;    //$activity->subject            = 'New Member Needs Approval';    //$activity->target_contact_id  = $relatedOrgID;     //$activity->save( );        if (!empty($form->_submitValues['membership_renewal'])) {        $activity_subject = "Membership Renewal - Needs Approval";                $membershipID = $form->_params['membershipID'];        $start_date = date('Ymd');        $end_date   = date('Ymd', strtotime ("+1 year $start_date"));        $end_date   = date('Ymd', strtotime ("-1 day $end_date"));                //$objectRef->start_date = $start_date;        //$mem_sql = "UPDATE civicrm_membership SET end_date = '$end_date' WHERE id = '$membershipID'";        //$mem_dao = CRM_Core_DAO::executeQuery( $mem_sql );        $activity_type_id = CIVICRM_MTL_UTILS_MEMBERSHIP_RENEWAL_ACTIVITY_ID;                require_once 'CRM/Core/Session.php';        $session = CRM_Core_Session::singleton();        $details = $session->get('new_description');             } else {        $activity_subject = "New Member  - Needs Approval";        $activity_type_id = CIVICRM_MTL_UTILS_NEW_MEMBER_ACTIVITY_ID;        $details = "";       }    // create the activity for new member or renewal     mtl_utils_civicrm_post_create_associated_activity( $activity_type_id , $contact_id , $relatedOrgID , $activity_subject , 1 , $details );}function mtl_utils_civicrm_post( $op, $objectName, $objectId, &$objectRef ){        if (($op == 'create' || $op == 'edit') && $objectName == 'Organization') {        require_once 'CRM/Core/Session.php';        $session = CRM_Core_Session::singleton( );        $session->set( 'org_id' , $objectId);    }        if ($op == 'create' && $objectName == 'Profile') {        require_once 'CRM/Utils/System.php';        if ($objectRef['uf_group_id'] == CIVICRM_MTL_UTILS_FULL_VOTING_MEMBERSHIP_PROFILE_ID) {                    require_once 'CRM/Core/Session.php';            $session = CRM_Core_Session::singleton( );            $contact_id = $session->get( 'org_id');                        require_once 'api/v2/Contact.php';            $contact_params    = array(                   'contact_id' => $contact_id                   );            $retrieved = &civicrm_contact_get( $contact_params );            $contact_type = $retrieved[$contact_id]['contact_type'];             //print_r ($objectRef);echo "<hr />";            //print_r ($_POST);exit;                        /*$sql = "INSERT INTO civicrm_value_directory_form_39 SET name_of_helpline__a_312 = '' , what_type_of_helpline_service_do_315 = '' , helpline_telephone_number__a_316 = '',                    helpline_sms_text_message_number_317 = '' , helpline_email_address__a_318 = '' , web_address__a_319 = '' , do_you_have_a_forum_or_other_int_320 = '' ,                     please_give_the_url_of_your_inte_321 = '' , please_describe_your_interactive_322 = '' , do_you_have_an_instant_messenger_323 = '' , if_yes_how_is_it_accessed_a_324 = '' ,                    are_you_able_to_help_callers_who_331 = '', if_languages_other_than_english__333 = '' , which_chapter_heading_s_should___343 = '' , what_keywords_should_we_use_to_i_344 = '' ,                    a__please_describe_briefly_your__345 = '' , a__please_describe_briefly_any_o_346 = '' , a__national_helplines_347 = '' , a__local_helplines__england__who_348 = '' ,                    a__local_helplines__scotland_349 = '' , a__local_helplines__rest_of_engl_350 = '' , a__local_helplines__wales_351 = '' , a__local_helplines__northern_ire_352 = ''";            */                        $params = array(                             'contact_id'    => $contact_id ,                             'contact_type'  => $contact_type ,                             'custom_312'    => $objectRef['custom_222'] ,  'custom_315'    => $objectRef['custom_39'] ,   'custom_316'    => $objectRef['custom_180'] ,   'custom_317'    => $objectRef['custom_184'] ,  'custom_318'    => $objectRef['custom_183'] ,                               'custom_319'    => $objectRef['custom_43'] ,  'custom_320'    => $objectRef['custom_196'] ,   'custom_321'    => $objectRef['custom_189'] ,   'custom_322'    => $objectRef['custom_188'] ,  'custom_323'    => $objectRef['custom_185'] ,                              'custom_324'    => $objectRef['custom_197'] ,  'custom_331'    => $objectRef['custom_161'] ,  'custom_331'    => $objectRef['custom_311'] ,  'custom_333'    => $objectRef['custom_60'] ,   'custom_343'    => $objectRef['custom_160'] ,  'custom_344'    => $objectRef['custom_206'] ,                              'custom_345'    => $objectRef['custom_165'] ,  'custom_346'    => $objectRef['custom_164'] ,   'custom_347'    => $objectRef['custom_219'] ,   'custom_348'    => $objectRef['custom_218'] ,  'custom_349'    => $objectRef['custom_149'] ,                              'custom_350'    => $objectRef['custom_217'] ,  'custom_351'    => $objectRef['custom_150'] ,   'custom_352'    => $objectRef['custom_151'] ,                            );            //print_r ($params);exit;                        $contact =&civicrm_contact_update( $params );            drupal_goto( 'civicrm/contribute/transact' , 'reset=1&id=1');            CRM_Utils_System::civiExit( );        }        if ($objectRef['uf_group_id'] == CIVICRM_MTL_UTILS_ASSOCIATE_MEMBERSHIP_PROFILE_ID) {            drupal_goto( 'civicrm/contribute/transact' , 'reset=1&id=3');            CRM_Utils_System::civiExit( );        }        /*if ($objectRef['uf_group_id'] == 29) {            drupal_goto( 'civicrm/contribute/transact' , 'reset=1&id=6');            CRM_Utils_System::civiExit( );        }*/    }        if ($op == 'edit' && $objectName == 'Profile') {        require_once 'CRM/Utils/System.php';        if ($objectRef['uf_group_id'] == CIVICRM_MTL_UTILS_SPECIAL_FREEPHONE_TARIFF_PROFILE_ID) {            drupal_goto( 'civicrm/contribute/transact' , 'reset=1&id=2');            CRM_Utils_System::civiExit( );        }        if ($objectRef['uf_group_id'] == CIVICRM_MTL_UTILS_FULL_VOTING_MEMBERSHIP_PROFILE_ID) {            drupal_goto( 'civicrm/contribute/transact' , 'reset=1&cid='.$_POST['org_id'].'&id=1');            CRM_Utils_System::civiExit( );        }    }        if ($op == 'edit' && $objectName == 'Activity') {        $activity_id = $objectId;        $activity_type_id = $objectRef->activity_type_id;                $sql = "SELECT * FROM civicrm_activity_target WHERE activity_id = '$activity_id'";        $dao = CRM_Core_DAO::executeQuery( $sql );        $dao->fetch();                $create_activity = false;                 if (($objectRef->activity_type_id == CIVICRM_MTL_UTILS_NEW_MEMBER_ACTIVITY_ID || $objectRef->activity_type_id == CIVICRM_MTL_UTILS_EC_APPROVAL_ACTIVITY_ID || $objectRef->activity_type_id == CIVICRM_MTL_UTILS_SEND_WELCOME_PACK_ACTIVITY_ID ) && $objectRef->status_id == 2) {            if ($objectRef->activity_type_id == CIVICRM_MTL_UTILS_NEW_MEMBER_ACTIVITY_ID) {                $activity_type_id = CIVICRM_MTL_UTILS_EC_APPROVAL_ACTIVITY_ID;                $subject = "EC Approval";            }                if ($objectRef->activity_type_id == CIVICRM_MTL_UTILS_EC_APPROVAL_ACTIVITY_ID) {                $activity_type_id = CIVICRM_MTL_UTILS_SEND_WELCOME_PACK_ACTIVITY_ID;                $subject = "Send Invoice/Welcome Pack";            }                    if ($objectRef->activity_type_id == CIVICRM_MTL_UTILS_SEND_WELCOME_PACK_ACTIVITY_ID) {                $activity_type_id = CIVICRM_MTL_UTILS_AWAITING_PAYMENT_ACTIVITY_ID;                $subject = "Awaiting Payment";            }            $create_activity = true;        }             if ($objectRef->activity_type_id == CIVICRM_MTL_UTILS_MEMBERSHIP_RENEWAL_ACTIVITY_ID && $objectRef->status_id == 2) {            $activity_type_id = CIVICRM_MTL_UTILS_AWAITING_PAYMENT_ACTIVITY_ID;            $subject = "Awaiting Payment";            $create_activity = true;        }                if ($objectRef->activity_type_id == CIVICRM_MTL_UTILS_NEW_MEMBER_ACTIVITY_ID && $objectRef->status_id == 3) {            $activity_type_id = 2;            $subject = "Membership - Not Approved. Follow up";            $create_activity = true;        }        if ($create_activity == true) {            mtl_utils_civicrm_post_create_associated_activity( $activity_type_id , $objectRef->source_contact_id , $dao->target_contact_id , $subject , 1  );        }            }}function mtl_utils_civicrm_post_create_associated_activity ($activity_type_id , $source_contact_id , $target_contact_id , $subject , $status , $details = null ) {    require_once 'api/v2/Activity.php';     $params = array(       'activity_type_id' => $activity_type_id,       'source_contact_id' => $source_contact_id,       'target_contact_id' => $target_contact_id,       'subject' => $subject,       'status_id' => $status,       'activity_date_time' => date('YmdHis') ,       'details' => $details     );     $act = civicrm_activity_create($params);     $activity_id = $act['id'];     $sql = "SELECT * FROM civicrm_group_contact WHERE group_id = '".CIVICRM_MTL_UTILS_MEMBERSHIP_APPROVAL_GROUP_ID."'";     $dao = CRM_Core_DAO::executeQuery( $sql );     while($dao->fetch()) {          require_once 'CRM/Activity/DAO/ActivityAssignment.php';          $assignment = new CRM_Activity_DAO_ActivityAssignment( );          $assignment->activity_id = $activity_id;          $assignment->assignee_contact_id = $dao->contact_id;          $assignment->save( );     }} function mtl_utils_civicrm_buildForm( $formName, &$form ) {        if ($formName == 'CRM_Profile_Form_Edit' && $form->getVar( '_gid' ) == CIVICRM_MTL_UTILS_FULL_VOTING_MEMBERSHIP_PROFILE_ID) {        global $user;        if ($user->uid) {             // this user is already logged in        } else {            drupal_set_message("Please Login");            $dest = drupal_get_destination();            drupal_goto('user', $dest); // this remembers where the user is coming from        }    }        if ($formName == 'CRM_Profile_Form_Edit' && $form->getVar( '_gid' ) == CIVICRM_MTL_UTILS_SPECIAL_FREEPHONE_TARIFF_PROFILE_ID) {        require_once 'CRM/Core/Session.php';        $session = CRM_Core_Session::singleton( );        $org_id = $session->get('org_id');                if(!empty($org_id)) {                    require_once 'api/v2/Contact.php';                     $params = array(                            'contact_id'=>$org_id                            );                                        $retrieved = &civicrm_contact_get( $params );                                                 //echo "<pre>";print_r ($retrieved);echo "</pre>";exit;                        $sql = "SELECT * FROM civicrm_contact WHERE id = '$org_id'";            $dao = CRM_Core_DAO::executeQuery( $sql );            $dao->fetch();                        $temp_hash = $dao->hash;            $ts = time( );            $live = 24 * 7;            $cs = md5( "{$temp_hash}_{$org_id}_{$ts}_{$live}" );            $cs1 = $cs."_".$ts."_".$live;                        require_once 'CRM/Utils/System.php';            //$id = $_GET['id'];            if ($_GET['id']== null) {              drupal_goto( 'civicrm/profile/edit' , 'reset=1&gid=17&id='.$org_id.'&cs='.$cs1);              CRM_Utils_System::civiExit( );            }                        $defaults['organization_name'] = $retrieved[$org_id]['display_name'];            $defaults['street_address-Primary'] = $retrieved[$org_id]['street_address'];            $defaults['supplemental_address_1-Primary'] = $retrieved[$org_id]['supplemental_address_1'];            $defaults['supplemental_address_2-Primary'] = $retrieved[$org_id]['supplemental_address_2'];            $defaults['city-Primary'] = $retrieved[$org_id]['city'];            $defaults['postal_code-Primary'] = $retrieved[$org_id]['postal_code'];            $defaults['state_province-Primary'] = $retrieved[$org_id]['state_province_id'];            $defaults['country-Primary'] = $retrieved[$org_id]['country_id'];            //$defaults['email[1][email]'] = $retrieved[$org_id]['email'];            //$defaults['phone[1][phone]'] = $retrieved[$org_id]['phone'];                        //$defaults['email-5'] = $session->get('registration_email');                        $form->setDefaults($defaults);        }        }    if ($formName == 'CRM_Contribute_Form_Contribution_Main' && ($form->getVar( '_id' ) == 1 || $form->getVar( '_id' ) == 2 || $form->getVar( '_id' ) == 3)) {        require_once 'CRM/Core/Session.php';        $session = CRM_Core_Session::singleton( );        $org_id = $session->get('org_id');                global $user;                if(!empty($org_id)) {                    require_once 'api/v2/Contact.php';                     $params = array(                            'contact_id'=>$org_id                            );                                        $retrieved = &civicrm_contact_get( $params );                                                 //echo "<pre>";print_r ($retrieved);echo "</pre>";exit;                        $defaults['organization_name'] = $retrieved[$org_id]['display_name'];            $defaults['address[1][street_address]'] = $retrieved[$org_id]['street_address'];            $defaults['address[1][supplemental_address_1]'] = $retrieved[$org_id]['supplemental_address_1'];            $defaults['address[1][supplemental_address_2]'] = $retrieved[$org_id]['supplemental_address_2'];            $defaults['address[1][city]'] = $retrieved[$org_id]['city'];            $defaults['address[1][postal_code]'] = $retrieved[$org_id]['postal_code'];            $defaults['address[1][state_province_id]'] = $retrieved[$org_id]['state_province_id'];            $defaults['address[1][country_id]'] = $retrieved[$org_id]['country_id'];            $defaults['email[1][email]'] = $retrieved[$org_id]['email'];            $defaults['phone[1][phone]'] = $retrieved[$org_id]['phone'];                        $defaults['email-5'] = $session->get('registration_email');                        if ($user->mail != null)                $defaults['email-5'] = $user->mail;                        $form->setDefaults($defaults);        }         }}