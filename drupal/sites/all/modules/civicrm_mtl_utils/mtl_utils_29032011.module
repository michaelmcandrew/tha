<?php// $Id: MtlUtils.module,v 1.263.2.4 2010/11/02 10:16:54 goba Exp $function mtl_utils_civicrm_contactListQuery( &$query, $name, $context, $id ) {    if ($context == 'navigation') {        $query = "SELECT cc.id as id, CONCAT_WS( ' :: ', sort_name, email, phone, street_address, city, ste.name, coy.name ) as data, sort_name                       FROM civicrm_contact cc LEFT JOIN civicrm_email eml ON ( cc.id = eml.contact_id AND eml.is_primary = 1 )                       LEFT JOIN civicrm_phone phe ON ( cc.id = phe.contact_id AND phe.is_primary = 1 )                       LEFT JOIN civicrm_address sts ON ( cc.id = sts.contact_id AND sts.is_primary = 1)                       LEFT JOIN civicrm_state_province ste ON ( sts.state_province_id = ste.id )                       LEFT JOIN civicrm_country coy ON ( sts.country_id = coy.id )                      WHERE sort_name LIKE '%$name%' OR external_identifier = '$name'                      LIMIT 0,10";     }    if ($context == 'customfield' && $id == 96) {        $query = "SELECT cc.id as id, display_name as data                       FROM civicrm_contact cc                        WHERE contact_sub_type = 'Region'                      LIMIT 0,13";    }    }function mtl_utils_civicrm_tokens( &$tokens ) {    $tokens['contact'] = array( 'member_rep_name', 'member_rep_jobtitle' , 'chief_executive_name', 'chief_executive_jobtitle' );}function mtl_utils_civicrm_tokenValues( &$values, &$contactIDs ) {    //print_r ($values);exit;        if ( is_array( $contactIDs ) ) {        $contactIDString = implode( ',', array_values( $contactIDs ) );        $single = false;    } else {        $contactIDString = "( $contactIDs )";        $single = true;    }        if ( is_array( $contactIDs ) ) {            while(list($key,$val) = each($contactIDs)) {                         $contactIDString = $val;                        require_once "api/v2/Relationship.php";            $params = array(                        'contact_id'         => $contactIDString                        );                              //echo '<pre>';print_r($params);echo '</pre>';                              $result =  civicrm_contact_relationship_get ($params );            //echo '<pre>';print_r($result);echo '</pre>';exit;                        if($result['is_error'] == 0 ) {                            $temp_array = $result['result'];                                while( list( $k, $v ) = each($temp_array) ) {                        if( $v['civicrm_relationship_type_id'] == 10 AND $v['relation'] == 'Member Rep') {                            $member_rep_id = $v['cid'];                        }                        if( $v['civicrm_relationship_type_id'] == 11 AND $v['relation'] == 'Chief Executive is' ) {                            $chief_exe_id = $v['cid'];                        }                    }                                require_once "api/v2/Contact.php";                $params    = array(                       'contact_id' => $member_rep_id,                       'return.sort_name' => 1,                       'return.display_name' => 1,                       'return.job_title' => 1                       );                $retrieved = &civicrm_contact_get( $params );                                //print_r ($retrieved);                                if ( ! array_key_exists( $contactIDString, $values ) ) {                     $values[$contactIDString] = array( );                }                                $value =& $values[$contactIDString];                                $value['member_rep_name'] = $retrieved[$member_rep_id]['display_name'];                if( empty($retrieved[$member_rep_id]['display_name']) ) {                     $value['member_rep_name'] = $retrieved[$member_rep_id]['sort_name'];                    }                $value['member_rep_jobtitle'] = $retrieved[$member_rep_id]['job_title'];                                $params    = array(                       'contact_id' => $chief_exe_id,                       'return.sort_name' => 1,                       'return.display_name' => 1,                       'return.job_title' => 1                       );                $retrieved = &civicrm_contact_get( $params );                                //print_r ($retrieved);                                if ( ! array_key_exists( $contactIDString, $values ) ) {                     $values[$contactIDString] = array( );                }                                $value =& $values[$contactIDString];                                $value['chief_executive_name'] = $retrieved[$chief_exe_id]['display_name'];                if( empty($retrieved[$chief_exe_id]['display_name']) ) {                     $value['chief_executive_name'] = $retrieved[$chief_exe_id]['sort_name'];                    }                $value['chief_executive_jobtitle'] = $retrieved[$chief_exe_id]['job_title'];                                            }            }    }    //print_r ($value);exit;}